{% extends "base.html" %}

{% block title %}dashboard - kiwa{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h2>your files</h2>
            {% if current_user.is_authenticated %}
                <p class="logged-in-text">logged in as {{ current_user.username }}</p>
            {% endif %}
        </div>
        <button id="uploadBtn" class="btn btn-primary">upload new file</button>
    </div>
    
    <!-- Stats Section -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <h3>your files</h3>
            <p class="stat-number">{{ user_files_count }}</p>
            <p class="stat-description">of {{ total_files }} total files</p>
        </div>
        
        <div class="stat-card">
            <h3>file ownership</h3>
            <div class="pie-chart-container">
                <canvas id="fileOwnershipChart" width="100" height="100"></canvas>
            </div>
            <p class="stat-description">{{ user_file_percentage | round(1) }}% of all files</p>
        </div>
    </div>
    
    <!-- Download Graph -->
    <div class="chart-container">
        <h3>downloads (last 2 weeks)</h3>
        <canvas id="downloadChart"></canvas>
    </div>
    
    <div class="file-upload-modal" id="uploadModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>upload file</h3>
            <form id="uploadForm" method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
                {{ upload_form.hidden_tag() }}
                
                <div class="form-group">
                    {{ upload_form.file.label(class="form-label") }}
                    {{ upload_form.file(class="form-input file-input", id="fileInput") }}
                    <div class="drop-area" id="dropArea">
                        <p>drag & drop a file here or click to browse</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        {{ upload_form.expiry_time.label(class="form-label") }}
                        {{ upload_form.expiry_time(class="form-select") }}
                    </div>
                    
                    <div class="form-group">
                        {{ upload_form.download_limit.label(class="form-label") }}
                        {{ upload_form.download_limit(class="form-select") }}
                    </div>
                </div>
                
                <div class="form-group">
                    {{ upload_form.password.label(class="form-label") }}
                    {{ upload_form.password(class="form-input") }}
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">upload</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="files-container">
        {% if files %}
            {% for file in files %}
                <div class="file-card">
                    <div class="file-info">
                        <h4>{{ file.original_filename }}</h4>
                        <p>{{ file.file_size | filesizeformat }} • uploaded {{ file.upload_date.strftime('%Y-%m-%d') }}</p>
                        <p>
                            {% if file.expiry_date %}
                                expires: {{ file.expiry_date.strftime('%Y-%m-%d') }}
                            {% else %}
                                no expiry
                            {% endif %}
                            • 
                            {% if file.download_limit %}
                                {{ file.download_count }}/{{ file.download_limit }} downloads
                            {% else %}
                                {{ file.download_count }} downloads
                            {% endif %}
                        </p>
                    </div>
                    <div class="file-actions">
                        <a href="{{ url_for('file_detail', file_id=file.id) }}" class="btn btn-secondary">share</a>
                        <a href="{{ url_for('delete_file', file_id=file.id) }}" class="btn btn-danger" 
                           onclick="return confirm('are you sure you want to delete this file?')">delete</a>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>you haven't uploaded any files yet.</p>
                <button id="uploadBtn2" class="btn btn-primary">upload your first file</button>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Modal functionality
    const modal = document.getElementById("uploadModal");
    const btn = document.getElementById("uploadBtn");
    const btn2 = document.getElementById("uploadBtn2");
    const span = document.getElementsByClassName("close")[0];
    
    // Chart instances
    let downloadChart = null;
    let ownershipChart = null;
    
    if (btn) {
        btn.onclick = function() {
            modal.style.display = "block";
        }
    }
    
    if (btn2) {
        btn2.onclick = function() {
            modal.style.display = "block";
        }
    }
    
    if (span) {
        span.onclick = function() {
            modal.style.display = "none";
        }
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    
    // Drag and drop functionality
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    
    if (dropArea && fileInput) {
        // Add click event to drop area
        dropArea.addEventListener('click', function() {
            fileInput.click();
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            // Only allow one file
            if (files.length > 0) {
                fileInput.files = [files[0]]; // Only take the first file
                dropArea.querySelector('p').textContent = `${files[0].name} selected`;
            }
        }
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                // Only show the first file even if multiple were selected
                dropArea.querySelector('p').textContent = `${this.files[0].name} selected`;
            } else {
                dropArea.querySelector('p').textContent = 'drag & drop a file here or click to browse';
            }
        });
    }
    
    // Function to destroy existing charts
    function destroyCharts() {
        if (downloadChart) {
            downloadChart.destroy();
            downloadChart = null;
        }
        if (ownershipChart) {
            ownershipChart.destroy();
            ownershipChart = null;
        }
    }
    
    // Function to initialize charts
    function initCharts() {
        // Destroy existing charts first
        destroyCharts();
        
        // Download chart
        const ctx = document.getElementById('downloadChart').getContext('2d');
        const downloadData = {{ download_data | tojson }};
        
        // Set canvas height explicitly
        const canvas = document.getElementById('downloadChart');
        canvas.height = 200;
        
        downloadChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: downloadData.map(d => d.date),
                datasets: [{
                    label: 'Downloads',
                    data: downloadData.map(d => d.downloads),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // File ownership chart
        const ownershipCtx = document.getElementById('fileOwnershipChart').getContext('2d');
        const userFiles = {{ user_files_count }};
        const totalFiles = {{ total_files }};
        const otherFiles = totalFiles - userFiles;
        
        ownershipChart = new Chart(ownershipCtx, {
            type: 'doughnut',
            data: {
                labels: ['Your Files', 'Other Files'],
                datasets: [{
                    data: [userFiles, otherFiles],
                    backgroundColor: [
                        '#3b82f6',
                        '#94a3b8'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                cutout: '70%'
            }
        });
    }
    
    // Initialize charts when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure everything is ready
        setTimeout(initCharts, 100);
    });
</script>
{% endblock %}